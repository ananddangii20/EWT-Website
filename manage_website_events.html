<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Website Content Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-amber-50 min-h-screen">
    <nav class="bg-amber-700 text-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
        <span class="font-bold text-xl">Website Content Manager</span>
        <div class="flex gap-4">
            <button onclick="showSection('events')" class="hover:text-amber-200 font-semibold underline">Events</button>
            <button onclick="showSection('impact')" class="hover:text-amber-200 font-semibold underline">Impact Stories</button>
            <span class="border-r border-amber-400 mx-2"></span>
            <a href="admin_dashboard.html" class="bg-white text-amber-700 px-4 py-2 rounded font-bold hover:bg-gray-100">Back to Dashboard</a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-6">
        
        <div id="section-events" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                <h2 class="text-2xl font-bold text-amber-800 mb-4">Publish Website Event</h2>
                <form id="public-event-form" class="space-y-4">
                    <div><label class="block text-sm font-medium">Event Title</label><input type="text" id="p-title" required class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-medium">Date</label><input type="date" id="p-date" required class="w-full border p-2 rounded"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">Time</label><input type="text" id="p-time" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-sm font-medium">Location</label><input type="text" id="p-location" class="w-full border p-2 rounded"></div>
                    </div>
                    <div><label class="block text-sm font-medium">Faculty</label><input type="text" id="p-faculty" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-medium">Description</label><textarea id="p-desc" rows="3" class="w-full border p-2 rounded"></textarea></div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold">Publish Event</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-amber-800 mb-4">Active Website Events</h2>
                <table class="w-full text-left border-collapse"><tbody id="public-events-list"></tbody></table>
            </div>
        </div>

        <div id="section-impact" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                <h2 class="text-2xl font-bold text-amber-800 mb-4">Add Impact Story</h2>
                <form id="impact-form" class="space-y-4">
                    <div><label class="block text-sm font-medium">Title</label><input type="text" id="i-title" required class="w-full border p-2 rounded"></div>
                    <div>
                        <label class="block text-sm font-medium">Upload Video</label>
                        <input type="file" id="i-video" accept="video/*" required class="w-full border p-2 rounded bg-gray-50">
                    </div>
                    <div><label class="block text-sm font-medium">Description</label><textarea id="i-desc" rows="4" required class="w-full border p-2 rounded"></textarea></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">Add Story</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-amber-800 mb-4">Current Impact Stories</h2>
                <div id="impact-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

    </main>

    <script>
        const token = localStorage.getItem('token');
        const BASE_URL = 'http://localhost:5000'; // Change if needed

        if(!token) window.location.href = 'login.html';

        function showSection(section) {
            document.getElementById('section-events').classList.add('hidden');
            document.getElementById('section-impact').classList.add('hidden');
            document.getElementById('section-' + section).classList.remove('hidden');
        }

        // --- EVENTS LOGIC ---
        async function fetchEvents() {
            const res = await fetch(`${BASE_URL}/api/website-events`);
            const data = await res.json();
            document.getElementById('public-events-list').innerHTML = data.map(e => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${new Date(e.event_date).toLocaleDateString()}</td>
                    <td class="p-3 font-medium">${e.title}</td>
                    <td class="p-3"><button onclick="deleteEvent(${e.id})" class="text-red-600 font-bold">Delete</button></td>
                </tr>`).join('');
        }
        document.getElementById('public-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await fetch(`${BASE_URL}/api/website-events`, {
                method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${token}`},
                body: JSON.stringify({
                    title: document.getElementById('p-title').value,
                    event_date: document.getElementById('p-date').value,
                    time: document.getElementById('p-time').value,
                    location: document.getElementById('p-location').value,
                    faculty: document.getElementById('p-faculty').value,
                    description: document.getElementById('p-desc').value
                })
            });
            e.target.reset(); fetchEvents(); alert('Event Published');
        });
        async function deleteEvent(id) {
            if(confirm('Delete event?')) {
                await fetch(`${BASE_URL}/api/website-events/${id}`, { method: 'DELETE', headers: {'Authorization':`Bearer ${token}`} });
                fetchEvents();
            }
        }

        // --- IMPACT LOGIC ---
        async function fetchImpact() {
            const res = await fetch(`${BASE_URL}/api/impact`);
            const data = await res.json();
            document.getElementById('impact-list').innerHTML = data.map(s => `
                <div class="border rounded p-3 relative">
                    <button onclick="deleteImpact(${s.id})" class="absolute top-2 right-2 text-red-600 font-bold bg-white px-2 rounded">X</button>
                    <video src="${BASE_URL}/${s.video_url}" class="w-full h-32 object-cover bg-black mb-2"></video>
                    <h3 class="font-bold">${s.title}</h3>
                    <p class="text-sm text-gray-600">${s.description.substring(0,60)}...</p>
                </div>`).join('');
        }

        document.getElementById('impact-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('i-video');
            const title = document.getElementById('i-title').value;
            const desc = document.getElementById('i-desc').value;

            if(fileInput.files.length === 0) return alert('Please select a file');

            const formData = new FormData();
            formData.append('video', fileInput.files[0]);
            formData.append('title', title);
            formData.append('description', desc);

            try {
                const res = await fetch(`${BASE_URL}/api/impact`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }, // NO Content-Type!
                    body: formData
                });
                
                if(res.ok) {
                    alert('Story Added');
                    e.target.reset();
                    fetchImpact();
                } else {
                    const d = await res.json();
                    alert(d.message);
                }
            } catch(err) { alert('Upload failed'); }
        });

        async function deleteImpact(id) {
            if(confirm('Delete story?')) {
                await fetch(`${BASE_URL}/api/impact/${id}`, { method: 'DELETE', headers: {'Authorization':`Bearer ${token}`} });
                fetchImpact();
            }
        }

        // Init
        fetchEvents();
        fetchImpact();
    </script>
</body>
</html>